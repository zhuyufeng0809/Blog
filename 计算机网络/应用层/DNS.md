# 关于DNS

## 概述：
 
 <div align=center>
    <img src="http://ww2.sinaimg.cn/large/006tNc79gy1g3dik8zwa0j30ex05lglh.jpg" width="50%"/>
    <br>
 </div>

&emsp;&emsp;人们喜欢便于记忆的的主机名标识方式，而路由器则喜欢定长的、有层次结构的IP地址。为了折中这些不同的偏好，我们需要一种能进行主机名到IP地址转换的目录服务。这就是**域名系统（DNS）**。  

&emsp;&emsp;DNS：

* 一个由分层的DNS服务器实现的分布式数据库。
* 一个使得主机能够查询分布式数据库的应用层协议。

&emsp;&emsp;DNS协议运行在**UDP**之上，默认使用53号端口。  

&emsp;&emsp;DNS通常是由其他应用层协议所使用的，包括HTTP，SMTP和FTP，将用户提供的主机名解析为IP地址。除了进行主机名到IP地址的转换外，DNS还提供**主机别名服务（CName）**。

## 原理：
  
 <div align=center>
    <img src="http://ww3.sinaimg.cn/large/006tNc79gy1g3djpoy8tfj304s06kmx2.jpg" width="15%"/>
    <br>
 </div>


&emsp;&emsp;需要使用DNS服务的应用进程调用DNS进程，指明需要被转换的主机名。用户主机上的DNS接收到后，向网络中发送一个DNS查询报文。所有的DNS请求和回答报文使用UDP数据报经端口53发送。经过若干毫秒的时延后，用户主机上的DNS进程收到一个DNS回答报文。映射的结果将被传递到调用DNS进程的应用进程。因此，从用户主机上调用应用程序的角度看，DNS是一个提供简单、直接的转换服务的黑盒子。  

### 分布式、层次数据库：

 <div align=center>
    <img src="http://ww3.sinaimg.cn/large/006tNc79gy1g3dkn5pvzzj30ia0gowex.jpg" width="60%"/>
    <br>
 </div>

&emsp;&emsp;大致来说，有三种类型的DNS服务器：

* **根DNS服务器**：有400多个根域名服务器遍及世界。这些根域名服务器由13个不同的组织管理。
* **顶级DNS服务器**：对于每个顶级域和所有国家的顶级域，都有TLD服务器。
* **权威DNS服务器**：在因特网上具有公共可访问主机的每个组织机构必须提供公共可访问的DNS记录，这些记录将这些主机的名字映射为IP地址。

&emsp;&emsp;还有一类重要的DNS服务器，称为**本地DNS服务器**。每个ISP都有一台DNS服务器。当主机发送DNS请求时，该请求被发往本地DNS服务器，它起着**代理**的作用，并将该请求转发到DNS服务器层次结构中。

 <div align=center>
    <img src="http://ww2.sinaimg.cn/large/006tNc79gy1g3dkp359vuj30fx0j9t9x.jpg" width="50%"/>
    <br>
 </div>

&emsp;&emsp;**递归查询**是最常见，也是默认的解析方式。在这种解析方式中，如果客户端配置的本地名称服务器不能解析的话，则后面的查询全由本地名称服务器代替DNS客户端进行查询，直到本地名称服务器从权威名称服务器得到了正确的解析结果，然后由本地名称服务器告诉DNS客户端查询的结果。  

&emsp;&emsp;当所配置的本地名称服务器解析不了时，后面的查询工作是由本地名称服务器替代DNS客户端进行的（以“本地名称服务器”为中心），只需要本地名称服务器向DNS客户端返回最终的查询结果即可。而**迭代查询**的所有查询工作全部是DNS客户端自己进行（以“DNS客户端”自己为中心）。  

&emsp;&emsp;从理论上来讲，任何DNS查询既可以是迭代的也可能是递归的。实践中，**查询通常是上图中的混合模式：从请求主机到本地DNS服务器的查询是递归的，其余的查询是迭代的**。

### DNS缓存：

&emsp;&emsp;实际上，为了改善时延性能并减少在因特网上到处传输的DNS报文数量，DNS广泛使用了缓存技术，也就是**DNS缓存**。在一个请求链中，当某DNS服务器收到一个DNS回答时，它能将映射缓存到本地存储器中。  

&emsp;&emsp;如果在DNS服务器中缓存了一台主机名/IP地址对，另一个对相同主机名的查询到达该DNS服务器时，该DNS服务器就能够提供所要求的IP地址，即使它不是该主机名的权威服务器。  

&emsp;&emsp;由于主机和主机名与IP地址间的映射并不是永久的，DNS服务器在一段时间后（通常设置为两天）将丢弃缓存的信息。  

&emsp;&emsp;事实上，因为缓存，除了少数DNS查询以外，根服务器都被绕过了。

### DNS记录和报文：

#### DNS记录：

&emsp;&emsp;资源记录是一个包含了下列字段的4元组：

        （Name，Value，Type，TTL）

&emsp;&emsp;TTL是该记录的生存时间，它决定了资源记录应当从缓存中删除的时间。**Name和Value的值取决于Type**。

* 如果Type=A，则Name是主机名，Value是该主机名对应的IP地址。
* 如果Type=NS，则Name是个域，而Value是个知道如何获得该域中主机IP地址的权威DNS服务器的主机名。
* 如果Type=CNAME，则Value是别名为Name的主机对应的规范主机名。
* 如果Type=MX，则Value是个别名为Name的邮件服务器的规范主机名。

#### DNS报文：

 <div align=center>
    <img src="http://ww4.sinaimg.cn/large/006tNc79ly1g3dn03uki9j30ln0bz0t6.jpg" width="60%"/>
    <br>
 </div>

&emsp;&emsp;DNS查询报文和回答报文拥有相同的格式。  

&emsp;&emsp;**首部**：前12字节为首部区域。第一个字段（标识符）是一个16比特的数，用于标识该查询。标志字段中含有若干标志。1比特的“查询/回答”标志位指出报文是查询报文（0）还是应答报文（1）。首部中还有4个有关数量的字段，这些字段指出了在首部后的4类数据区域出现的数量。

&emsp;&emsp;**问题区域**：包含正在进行的查询信息。该区域包括：名字字段，包含正在被查询的主机名字；类型字段，指出有关该名字的正被询问的问题类型。  

&emsp;&emsp;**回答区域**：包含了对最初请求的名字的资源记录。  

&emsp;&emsp;**权威区域**：包含了其他权威服务器的记录。  

&emsp;&emsp;**附加区域**：包含了其他有帮助的记录。

